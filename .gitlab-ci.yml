include:
  - project: 'shared/ci-utils'
    file: 'triply-etl.yml'

default: 
  tags: 
    - etl

workflow:
  name: $PIPELINE_NAME


stages:
  # 0: Only install, lint and build, gets triggered on push and merge-requests:
  - preflight
  # 1: Run all regular ETL's:
  - run-etls

image: node:20.9-bullseye-slim

### Stage 0: Only install, lint and build, gets triggered on push and merge-requests:
preflight:
  stage: preflight
  script:
    - !reference [.etl-template, install]
  rules:
    - !reference [.etl-template, rules-preflight]

### Stage 1: run ETL "main"
main:
  stage: run-etls
  interruptible: true
  # WARNING: by setting 'allow_failure' to 'true' scripts that fail
  # will not stop the ETL from continuing with other stages/scripts.
  allow_failure: false
  artifacts:
    !reference [.etl-template, artifacts]
  script:
    - !reference [.etl-template, install]
    - !reference [.etl-template, run-etl]
  rules:
    - !reference [.etl-template, rules]

### Example stage 1: add another ETL with name "collections"
geodataCsv:
  stage: run-etls
  interruptible: true
  # WARNING: by setting 'allow_failure' to 'true' scripts that fail
  # will not stop the ETL from continuing with other stages/scripts.
  allow_failure: false
  artifacts:
    !reference [.etl-template, artifacts]
  script:
    - !reference [.etl-template, install]
    - !reference [.etl-template, run-etl]
  rules:
    - !reference [.etl-template, rules]