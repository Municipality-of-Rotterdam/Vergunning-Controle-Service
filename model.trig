

# External prefix declarations
prefix dbo:   <http://dbpedia.org/ontology/>
prefix rdfs:  <http://www.w3.org/2000/01/rdf-schema#>
prefix sh:    <http://www.w3.org/ns/shacl#>
prefix xsd:   <http://www.w3.org/2001/XMLSchema#>

# Project-specific prefix
prefix def:   <https://demo.triplydb.com/rotterdam/vcs/model/def/>
prefix graph: <https://demo.triplydb.com/rotterdam/vcs/graph/>
prefix ifc: <http://standards.buildingsmart.org/IFC/DEV/IFC4/ADD1/OWL#>
prefix shp:   <https://demo.triplydb.com/rotterdam/vcs/model/shp/>
graph:model {
  shp:Building
   a sh:NodeShape;
   sh:targetClass ifc:IfcBuilding;
   sh:sparql
    shp:BuildingMaxAantalPositieveBouwlagenSparql. 

  
shp:BuildingMaxAantalPositieveBouwlagenSparql
  a sh:SPARQLConstraint;
  sh:message 'Gebouw {?this} heeft in totaal {?totalNumberOfFloors} bouwlagen, dit mag maximaal 2 zijn.';
  sh:severity sh:Violation;
  sh:datatype xsd:string;
  sh:select '''
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX ifc: <http://standards.buildingsmart.org/IFC/DEV/IFC4/ADD1/OWL#>
PREFIX express: <https://w3id.org/express#>

SELECT ?this ?totalNumberOfFloors
WHERE {
  {
    SELECT ?this (COUNT(?positiveFloorLabel) + COUNT(?negativeFloorLabel) AS ?totalNumberOfFloors)
    WHERE {
      {
        SELECT ?this ?positiveFloorLabel WHERE {
          ?this a ifc:IfcBuilding .
          ?storey a ifc:IfcBuildingStorey;
                  ifc:name_IfcRoot ?storeyLabel.
          ?storeyLabel a ifc:IfcLabel;
                      express:hasString ?positiveFloorLabel.
          FILTER(REGEX(?positiveFloorLabel, "^(0?[1-9]|[1-9][0-9]) .*")) # Matches positive floors starting from '01'
          FILTER(?positiveFloorLabel != "00 begane grond") # Excludes '00 begane grond'
        }
      }
      UNION
      {
        SELECT ?this ?negativeFloorLabel WHERE {
          ?this a ifc:IfcBuilding .
          ?storey a ifc:IfcBuildingStorey;
                  ifc:name_IfcRoot ?storeyLabel.
          ?storeyLabel a ifc:IfcLabel;
                       express:hasString ?negativeFloorLabel.
          FILTER(REGEX(?negativeFloorLabel, "^-(0?[1-9]|[1-9][0-9]) .*")) # Matches negative floors starting from '-01'
        }
      }
    }
    GROUP BY ?this
  }
  FILTER (?totalNumberOfFloors > 2)
}
  '''.


  }    
